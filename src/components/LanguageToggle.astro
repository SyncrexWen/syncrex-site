---
// src/components/LanguageToggle.astro

/**
 * LanguageToggle
 * This component renders a language switcher button that allows users
 * to toggle between Chinese and English.
 * It also supports a "locked" state where one language is fixed and the other is unavailable,
 * showing a tooltip on hover to explain why.
 * The component relies on the `data-lang` attribute set on the root element (html)
 * to determine which language is currently active and applies styles accordingly.
 * Hovering over the button will temporarily enhance the visibility of both language options,
 * while the active language remains highlighted.
 */

interface Props {
    lockedLang?: 'zh' | 'en';
}

const { lockedLang } = Astro.props;

const tooltipText = lockedLang === 'zh' ? 'English translation not available' : '暂无中文版本';
---

<button
    id="lang-toggle"
    class:list={['focus-switch group', { 'is-locked': !!lockedLang }]}
    aria-label="Switch Language"
    data-locked={lockedLang}
    disabled={!!lockedLang}
>
    <span class="lang-item zh">中文</span>
    <span class="divider">/</span>
    <span class="lang-item en">EN</span>

    {
        lockedLang && (
            <span class="tooltip-popup" aria-hidden="true">
                {tooltipText}
            </span>
        )
    }

    <div class="glow-bg"></div>
</button>

<style>
    .focus-switch {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 99px;
        border: 1px solid var(--glass-border-primary);
        background-color: var(--glass-light-bg);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: visible;
    }

    .focus-switch:not(.is-locked) {
        cursor: pointer;
    }
    .focus-switch:not(.is-locked):hover {
        background-color: var(--glass-light-bg-hover);
        border-color: var(--glass-border-primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .focus-switch.is-locked {
        cursor: not-allowed;
        opacity: 0.8;
    }
    .lang-item {
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        position: relative;
        z-index: 10;
        transition:
            color 0.3s ease,
            opacity 0.3s ease,
            filter 0.3s ease,
            transform 0.3s ease;
        will-change: filter, opacity;
    }

    .divider {
        color: #cbd5e0;
        font-size: 0.875rem;
        font-weight: 300;
        transform: translateY(-1px);
    }

    :global(:root:not([data-lang])) .zh,
    :global(:root[data-lang='zh']) .zh {
        color: rgb(var(--theme-color-primary));
        opacity: 1;
        filter: blur(0);
        transform: scale(1.05);
    }
    :global(:root:not([data-lang])) .en,
    :global(:root[data-lang='zh']) .en {
        color: #a0aec0;
        opacity: 0.4;
        filter: blur(1.5px);
        font-weight: 500;
    }
    :global(:root[data-lang='en']) .en {
        color: rgb(var(--theme-color-primary));
        opacity: 1;
        filter: blur(0);
        transform: scale(1.05);
    }
    :global(:root[data-lang='en']) .zh {
        color: #a0aec0;
        opacity: 0.4;
        filter: blur(1.5px);
        font-weight: 500;
    }
    .focus-switch:not(.is-locked):hover .lang-item {
        filter: blur(0) !important;
        opacity: 0.8;
    }
    /* 保持高亮 */
    :global(:root[data-lang='zh']) .focus-switch:not(.is-locked):hover .zh {
        opacity: 1;
    }
    :global(:root[data-lang='en']) .focus-switch:not(.is-locked):hover .en {
        opacity: 1;
    }

    :global(:root[data-lang='zh']) .focus-switch.is-locked:hover .en {
        filter: blur(2px) !important;
        opacity: 0.3 !important;
    }
    :global(:root[data-lang='en']) .focus-switch.is-locked:hover .zh {
        filter: blur(2px) !important;
        opacity: 0.3 !important;
    }

    .tooltip-popup {
        position: absolute;
        top: 120%;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background-color: rgb(var(--theme-color-primary));
        color: #fff;
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 20;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .tooltip-popup::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent rgb(var(--theme-color-primary)) transparent;
    }
    .focus-switch.is-locked:hover .tooltip-popup {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }
</style>

<script>
    import { currentLang } from '../stores/language';

    const btn = document.getElementById('lang-toggle');

    if (btn) {
        const lockedLang = btn.dataset.locked;

        if (lockedLang && (lockedLang === 'zh' || lockedLang === 'en')) {
            if (currentLang.get() !== lockedLang) {
                currentLang.set(lockedLang);
            }
        } else {
            currentLang.subscribe((lang) => {
                document.documentElement.setAttribute('data-lang', lang);
            });

            btn.addEventListener('click', () => {
                const newLang = currentLang.get() === 'zh' ? 'en' : 'zh';
                currentLang.set(newLang);
            });
        }
    }
</script>
