---
// src/components/BaseHead.astro

/**
 * BaseHead
 * This component is responsible for rendering the <head> section of the HTML document.
 * It sets up the character encoding, viewport settings, favicon links, and meta tags for SEO and social sharing.
 * It also includes a script to handle theme initialization (dark mode) and language settings, as well as dynamic title updates based on the selected language.
 * Props:
 * - title: The title of the page, which can be a bilingual string (either a simple string or an object with 'zh' and 'en' properties).
 * - description: A brief description of the page, also supporting bilingual content.
 * - image: An optional URL for the social sharing image (default is '/blog-placeholder-1.jpg').
 */

import '../styles/global.css';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

type BilingualString = string | { zh: string; en: string };

interface Props {
  title: BilingualString;
  description: BilingualString;
  image?: string;
}

const { title, description, image = '/favicon.svg' } = Astro.props;

const getZh = (val: BilingualString) => (typeof val === 'object' ? val.zh : val);
const getEn = (val: BilingualString) => (typeof val === 'object' ? val.en : val);

const initialTitle = getZh(title);
const initialDesc = getZh(description);

const zhTitle = typeof title === 'string' ? title : title.zh;
const enTitle = typeof title === 'string' ? title : title.en;
const zhDesc = typeof description === 'string' ? description : description.zh;
const enDesc = typeof description === 'string' ? description : description.en;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.url);
const siteTitle = SITE_TITLE;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="shortcut icon" href="/favicon.ico" />
<meta name="generator" content={Astro.generator} />

<link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin />

<link rel="canonical" href={canonicalURL} />

<title>{initialTitle} | {siteTitle}</title>
<meta name="title" content={`${initialTitle} | ${siteTitle}`} />
<meta name="description" content={initialDesc} />

<meta id="meta-data-store"
  data-zh-title={`${zhTitle} | ${siteTitle}`}
  data-en-title={`${enTitle} | ${siteTitle}`}
  data-zh-desc={zhDesc}
  data-en-desc={enDesc}
/>

<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={initialTitle} />
<meta property="og:description" content={initialDesc} />
<meta property="og:image" content={socialImageURL} />

<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={initialTitle} />
<meta property="twitter:description" content={initialDesc} />
<meta property="twitter:image" content={socialImageURL} />

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
  integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
  crossorigin="anonymous"
>

<style is:global>
  :root:not([data-lang]) .lang-en,
  :root:not([data-lang]) .hidden-when-zh {
    display: none !important;
  }

  /* Hide English content when `html="en"` */
  :root[data-lang="zh"] .lang-en,
  :root[data-lang="zh"] .hidden-when-zh {
    display: none !important;
  }

  /* Hide Chinese content when `html="zh"` */
  :root[data-lang="en"] .lang-zh,
  :root[data-lang="en"] .hidden-when-en {
    display: none !important;
  }
</style>

<script is:inline>
  (function() {
    const getThemePreference = () => {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme');
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    const isDark = getThemePreference() === 'dark';
    document.documentElement.classList[isDark ? 'add' : 'remove']('dark');

    let currentLang = 'zh';
    try {
      currentLang = localStorage.getItem('site-lang') || 'zh';
      document.documentElement.setAttribute('data-lang', currentLang);
    } catch (e) {
      document.documentElement.setAttribute('data-lang', 'zh');
    }

    const updateTitle = (lang) => {
      const metaStore = document.getElementById('meta-data-store');
      if (!metaStore) return;

      const newTitle = metaStore.getAttribute(`data-${lang}-title`);
      const newDesc = metaStore.getAttribute(`data-${lang}-desc`);

      if (newTitle) document.title = newTitle;

      const descTag = document.querySelector('meta[name="description"]');
      if (descTag && newDesc) descTag.setAttribute('content', newDesc);
    };

    if (typeof localStorage !== 'undefined') {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes') {
             if(mutation.attributeName === 'class') {
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
             }

             if(mutation.attributeName === 'data-lang') {
                const newLang = document.documentElement.getAttribute('data-lang');
                updateTitle(newLang);
             }
          }
        });
      });
      observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-lang'] });

      document.addEventListener('DOMContentLoaded', () => {
        updateTitle(document.documentElement.getAttribute('data-lang') || 'zh');
      });
    }
  })();
</script>

<noscript>
  <style>
    .lang-en { display: none !important; }
    .lang-zh { display: block !important; }
    #lang-toggle { display: none !important; }
  </style>
</noscript>
