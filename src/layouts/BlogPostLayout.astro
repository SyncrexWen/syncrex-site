---
// src/layouts/BlogPostLayout.astro
import DefaultLayout from './DefaultLayout.astro';
import BackButton from '../components/BackButton.astro';
import TableOfContents from '../components/TableOfContents.astro';

// 1. 定义类型接口，提升代码健壮性
interface Props {
  title: string;
  description?: string;
  pubDate: Date;
  updatedDate?: Date;
  headings?: { depth: number; slug: string; text: string }[];
  heroImage?: string;
}

const { title, description, pubDate, updatedDate, headings = [] } = Astro.props;

const formatDate = (date: Date | string) => {
  const d = new Date(date);
  return isNaN(d.getTime()) ? date : d.toLocaleDateString('en-US', {
    year: 'numeric', month: 'long', day: 'numeric'
  });
};
---

<DefaultLayout title={title} description={description}>

  <div id="progress-container" class="fixed top-0 left-0 w-full h-1 z-[101] bg-transparent pointer-events-none">
    <div id="progress-bar" class="h-full bg-[#2d3748] w-0 transition-all duration-150 ease-out"></div>
  </div>

  <div class="relative max-w-4xl mx-auto px-4 sm:px-6 py-12">

    <div class="mb-6">
        <BackButton href="/blogs" text="Back to Blogs" theme="light" />
    </div>

    <header class="mb-10 text-center">
      <div class="flex items-center justify-center gap-4 text-sm text-gray-500 mb-6 font-mono">
        <time>Published: {formatDate(pubDate)}</time>
        {updatedDate && <span class="text-gray-400">/ Updated: {formatDate(updatedDate)}</span>}
      </div>

      <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-gray-900 mb-8 leading-tight">
        {title}
      </h1>

      {description && (
        <div class="text-left bg-gray-50 border-l-4 border-[#2d3748] p-6 rounded-r-lg">
          <span class="block font-bold text-xs text-[#2d3748] tracking-wider mb-2 uppercase">TL;DR</span>
          <p class="text-gray-600 italic text-lg leading-relaxed m-0">{description}</p>
        </div>
      )}
    </header>

    <article class="prose prose-lg prose-slate mx-auto max-w-none">
        <slot />
    </article>

    <div class="mt-16 pt-8 border-t border-gray-100 text-center text-gray-400 text-sm">
      <p>Thanks for reading.</p>
    </div>

  </div>

  <aside
    class="fixed right-8 top-32 w-64 z-10 hidden xl:block toc-card initial-state"
    id="floating-toc"
  >
    <div class="glass-card p-5">
        <h3 class="font-bold text-gray-900 mb-3 text-xs uppercase tracking-widest border-b border-gray-200/50 pb-2">
        Contents
        </h3>
        <TableOfContents headings={headings} />
    </div>
  </aside>

</DefaultLayout>

<style>
  /* === 1. 液态玻璃卡片 CSS === */
  .glass-card {
    background: rgba(255, 255, 255, 0.7); /* 稍微提高不透明度 */
    backdrop-filter: saturate(180%) blur(12px);
    -webkit-backdrop-filter: saturate(180%) blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 1rem;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.05),
      0 10px 15px -3px rgba(0, 0, 0, 0.05),
      inset 0 0 20px rgba(255, 255, 255, 0.5);
  }

  /* === 2. 复制按钮样式优化 === */
  :global(.copy-code-btn) {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    /* 增加深色背景适配性，加一点模糊 */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 20; /* 确保在代码之上 */
  }
  :global(pre:hover .copy-code-btn) { opacity: 1; }
  :global(.copy-code-btn:hover) {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    transform: translateY(-1px);
  }
  :global(pre) { position: relative; }

  /* === 3. TOC 动画 === */
  .toc-card {
    transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: opacity, transform;
  }
  .initial-state {
    opacity: 0;
    transform: translateY(20px); /* 稍微增加位移，动画更明显 */
    pointer-events: none;
  }
  .toc-visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* === 4. 强制宽度修正 === */
  .prose {
    max-width: 100% !important;
    width: 100%;
  }
  .prose img {
    width: 100%;
    max-width: 100%;
    border-radius: 0.75rem; /* 给图片加点圆角更精致 */
  }
</style>

<script>
  // === 性能优化版 Script ===

  const progressBar = document.getElementById('progress-bar');
  const tocContainer = document.getElementById('floating-toc');

  // 节流阀：防止每一帧都触发 DOM 操作
  let isTicking = false;

  function onScroll() {
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;

    // 1. 进度条计算
    const scrolled = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;

    if (!isTicking) {
      window.requestAnimationFrame(() => {
        // 更新进度条
        if (progressBar) {
          progressBar.style.width = scrolled + "%";
        }

        // 更新 TOC 状态
        if (tocContainer) {
          if (scrollTop > 300) {
            if (tocContainer.classList.contains('initial-state')) {
              tocContainer.classList.remove('initial-state');
              tocContainer.classList.add('toc-visible');
            }
          } else {
            if (tocContainer.classList.contains('toc-visible')) {
              tocContainer.classList.remove('toc-visible');
              tocContainer.classList.add('initial-state');
            }
          }
        }

        isTicking = false;
      });

      isTicking = true;
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });

  // === 复制代码功能 ===
  // 保持原样，逻辑已经很棒了
  const codeBlocks = document.querySelectorAll('pre');
  codeBlocks.forEach(pre => {
    const button = document.createElement('button');
    button.className = 'copy-code-btn';
    button.textContent = 'Copy';

    // 增加一个 hidden 的 textarea 逻辑通常更稳健，但 navigator.clipboard 在现代浏览器足够了
    button.addEventListener('click', async () => {
      // 优先取 code 标签，没有则取 pre
      const code = pre.querySelector('code')?.innerText || pre.innerText;
      try {
        await navigator.clipboard.writeText(code);
        button.textContent = 'Copied!';
        // 增加视觉反馈
        button.style.borderColor = '#4ade80'; // 绿色边框
        button.style.color = '#4ade80';

        setTimeout(() => {
            button.textContent = 'Copy';
            button.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            button.style.color = 'rgba(255, 255, 255, 0.8)';
        }, 2000);
      } catch (err) {
        button.textContent = 'Error';
      }
    });

    pre.appendChild(button);
  });
</script>
